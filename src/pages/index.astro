---
import Layout from '../layouts/Layout.astro';

// UI
import ButtonPrimary from '../components/ui/ButtonPrimary.astro';
import ButtonSecondary from '../components/ui/ButtonSecondary.astro';
import StatusIndicator from '../components/ui/StatusIndicator.astro';
import Divider from '../components/ui/Divider.astro';

// Nav
import Logo from '../components/nav/Logo.astro';
import NavItem from '../components/nav/NavItem.astro';
import HeaderBar from '../components/nav/HeaderBar.astro';
import Footer from '../components/nav/Footer.astro';

// Content
import SectionHeader from '../components/content/SectionHeader.astro';
import TerminalWindow from '../components/content/TerminalWindow.astro';
import SkillBar from '../components/content/SkillBar.astro';
import ProjectCard from '../components/content/ProjectCard.astro';
---

<Layout title="alex_dev — portfolio">
  <!-- Header -->
  <HeaderBar>
    <Logo name="alex_dev" slot="logo" />
    <Fragment slot="nav">
      <NavItem label="about" href="#about" active />
      <NavItem label="projects" href="#projects" />
      <NavItem label="skills" href="#skills" />
      <NavItem label="contact" href="#contact" />
    </Fragment>
    <StatusIndicator text="available for hire" slot="status" />
  </HeaderBar>

  <!-- Hero Section -->
  <section id="about" class="flex flex-col items-center gap-10 bg-bg-page px-16 pt-[120px] pb-[100px]">
    <div class="w-full max-w-[900px]">
      <TerminalWindow title="~/alex_dev — bash">
        <div id="hero-terminal">
          <p data-type="cmd" class="text-sm font-medium text-green-primary hidden">$ whoami</p>
          <p data-type="out" class="text-sm text-text-primary hidden">alex rodriguez — full-stack developer</p>
          <div data-type="out" class="h-3 hidden"></div>
          <p data-type="cmd" class="text-sm font-medium text-green-primary hidden">$ cat intro.txt</p>
          <p data-type="out" class="text-sm text-text-secondary hidden">i build things for the web. passionate about clean code,</p>
          <p data-type="out" class="text-sm text-text-secondary hidden">open source, and developer experience. currently crafting</p>
          <p data-type="out" class="text-sm text-text-secondary hidden">performant interfaces at startup.io</p>
          <div data-type="out" class="h-3 hidden"></div>
          <p data-type="cmd" class="text-sm font-medium text-green-primary hidden">$ echo $current_stack</p>
          <p data-type="out" class="text-sm text-text-primary hidden">typescript · react · node.js · postgresql · rust</p>
          <div data-type="out" class="h-3 hidden"></div>
          <p data-type="cmd" class="text-sm font-medium text-green-primary hidden">$ echo $experience</p>
          <p data-type="out" class="text-sm text-text-primary hidden">5+ years · 40+ projects · 12k+ github stars</p>
          <div data-type="out" class="h-4 hidden"></div>
          <div id="hero-cursor" class="flex items-center hidden">
            <span class="text-sm font-medium text-green-primary">$ </span>
            <span class="h-[18px] w-[9px] bg-green-primary animate-blink"></span>
          </div>
        </div>
      </TerminalWindow>
    </div>

    <!-- Hero Bottom -->
    <div id="hero-bottom" class="flex flex-col items-center gap-8 w-full max-w-[900px] opacity-0 transition-opacity duration-700">
      <h1 class="text-4xl font-semibold text-text-primary text-center">
        building the future, one commit at a time.
      </h1>
      <p class="text-sm text-text-tertiary text-center">
        // full-stack developer specializing in scalable systems and beautiful interfaces
      </p>
      <div class="flex items-center gap-4">
        <ButtonPrimary label="view_projects" icon="lucide:terminal" href="#projects" />
        <ButtonSecondary label="github_profile" icon="lucide:github" href="#" />
      </div>
    </div>
  </section>

  <Divider />

  <!-- Skills Section -->
  <section id="skills" class="flex flex-col gap-12 bg-bg-page px-16 py-20">
    <SectionHeader
      command="$ neofetch --skills"
      description="// system capabilities and proficiency levels"
    />
    <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
      <!-- Frontend -->
      <div class="flex flex-col gap-4 stagger-1" data-animate>
        <span class="text-sm font-medium text-text-primary">frontend:</span>
        <SkillBar name="react / next.js" percentage={95} />
        <SkillBar name="typescript" percentage={90} />
        <SkillBar name="tailwind css" percentage={88} />
      </div>
      <!-- Backend -->
      <div class="flex flex-col gap-4 stagger-2" data-animate>
        <span class="text-sm font-medium text-text-primary">backend:</span>
        <SkillBar name="node.js / express" percentage={92} />
        <SkillBar name="postgresql / redis" percentage={85} />
        <SkillBar name="rust / wasm" percentage={72} />
      </div>
      <!-- DevOps -->
      <div class="flex flex-col gap-4 stagger-3" data-animate>
        <span class="text-sm font-medium text-text-primary">devops:</span>
        <SkillBar name="docker / k8s" percentage={80} />
        <SkillBar name="aws / vercel" percentage={85} />
        <SkillBar name="git / ci·cd" percentage={93} />
      </div>
    </div>
  </section>

  <Divider />

  <!-- Projects Section -->
  <section id="projects" class="flex flex-col gap-12 bg-bg-page px-16 py-20">
    <div class="flex items-end justify-between">
      <SectionHeader
        command="$ ls -la ~/projects"
        description="// selected works and open source contributions"
      />
      <span class="text-xs text-text-muted">total: 6 projects</span>
    </div>
    <div class="grid grid-cols-1 gap-5 md:grid-cols-3">
      <div data-animate class="stagger-1">
        <ProjectCard
          title="flux_engine"
          description="// real-time data processing pipeline built with rust and webassembly for edge computing"
          stars={2400}
          link="#"
          tags={['rust', 'wasm', 'edge']}
        >
          <div slot="image" class="h-full w-full bg-gradient-to-br from-green-primary/20 to-bg-surface"></div>
        </ProjectCard>
      </div>
      <div data-animate class="stagger-2">
        <ProjectCard
          title="vex_cli"
          description="// developer toolkit cli that scaffolds, lints, and deploys full-stack applications"
          stars={5100}
          link="#"
          tags={['node', 'cli', 'oss']}
        >
          <div slot="image" class="h-full w-full bg-gradient-to-br from-blue-info/20 to-bg-surface"></div>
        </ProjectCard>
      </div>
      <div data-animate class="stagger-3">
        <ProjectCard
          title="signal_mesh"
          description="// p2p encrypted messaging protocol with zero-knowledge proof authentication"
          stars={4700}
          link="#"
          tags={['typescript', 'webrtc', 'crypto']}
        >
          <div slot="image" class="h-full w-full bg-gradient-to-br from-amber-warning/20 to-bg-surface"></div>
        </ProjectCard>
      </div>
    </div>
  </section>

  <Divider />

  <!-- Contact Section -->
  <section id="contact" class="flex flex-col items-center gap-12 bg-bg-page px-16 py-20">
    <div class="flex flex-col items-center gap-2">
      <h2 class="text-[28px] font-semibold text-green-primary">$ ping alex_dev</h2>
      <p class="text-[13px] text-text-tertiary text-center">
        // open to collaboration, freelance, and full-time opportunities
      </p>
    </div>

    <div id="contact-terminal-wrapper" class="w-full max-w-[700px]">
      <TerminalWindow title="~/contact — bash">
        <div id="contact-terminal">
          <p data-type="cmd" class="text-[13px] font-medium text-green-primary hidden">$ cat contact_info.json</p>
          <p data-type="out" class="text-[13px] text-text-muted whitespace-pre hidden">{"{"}</p>
          <p data-type="out" class="text-[13px] text-text-secondary whitespace-pre hidden">  "email":    "alex@rodriguez.dev",</p>
          <p data-type="out" class="text-[13px] text-text-secondary whitespace-pre hidden">  "github":   "github.com/alexrodriguez",</p>
          <p data-type="out" class="text-[13px] text-text-secondary whitespace-pre hidden">  "twitter":  "@alex_codes",</p>
          <p data-type="out" class="text-[13px] text-text-secondary whitespace-pre hidden">  "linkedin": "linkedin.com/in/alexrodriguez",</p>
          <p data-type="out" class="text-[13px] text-text-secondary whitespace-pre hidden">  "location": "san francisco, ca"</p>
          <p data-type="out" class="text-[13px] text-text-muted whitespace-pre hidden">{"}"}</p>
          <div data-type="out" class="h-2 hidden"></div>
          <div id="contact-cursor" class="flex items-center hidden">
            <span class="text-[13px] font-medium text-green-primary">$ </span>
            <span class="h-4 w-[9px] bg-green-primary animate-blink"></span>
          </div>
        </div>
      </TerminalWindow>
    </div>

    <ButtonPrimary label="send_message" icon="lucide:mail" href="mailto:alex@rodriguez.dev" />
  </section>

  <Divider />

  <!-- Footer -->
  <Footer brandName="alex_dev" copyright="// designed & built by alex rodriguez © 2026">
    <Fragment slot="links">
      <a href="#" class="text-xs text-text-tertiary hover:text-text-secondary transition">github</a>
      <a href="#" class="text-xs text-text-tertiary hover:text-text-secondary transition">twitter</a>
      <a href="#" class="text-xs text-text-tertiary hover:text-text-secondary transition">linkedin</a>
      <a href="#" class="text-xs text-text-tertiary hover:text-text-secondary transition">resume.pdf</a>
    </Fragment>
  </Footer>
</Layout>

<script>
  const reduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function sleep(ms: number) {
    return new Promise((r) => setTimeout(r, ms));
  }

  async function typeText(el: HTMLElement) {
    const text = el.textContent || '';
    el.textContent = '';
    el.classList.remove('hidden');
    for (const char of text) {
      el.textContent += char;
      await sleep(40);
    }
  }

  async function runTerminalSequence(containerId: string, cursorId: string) {
    const lines = document.querySelectorAll<HTMLElement>(`#${containerId} [data-type]`);
    const cursor = document.getElementById(cursorId);

    for (const line of lines) {
      if (line.dataset.type === 'cmd') {
        await typeText(line);
        await sleep(200);
      } else {
        line.classList.remove('hidden');
        await sleep(50);
      }
    }
    cursor?.classList.remove('hidden');
  }

  function showTerminalAll(containerId: string, cursorId: string) {
    document.querySelectorAll<HTMLElement>(`#${containerId} [data-type]`)
      .forEach((el) => el.classList.remove('hidden'));
    document.getElementById(cursorId)?.classList.remove('hidden');
  }

  // Hero terminal — runs immediately on load
  const heroBottom = document.getElementById('hero-bottom');

  if (reduced) {
    showTerminalAll('hero-terminal', 'hero-cursor');
    showTerminalAll('contact-terminal', 'contact-cursor');
    if (heroBottom) heroBottom.style.opacity = '1';
  } else {
    runTerminalSequence('hero-terminal', 'hero-cursor').then(async () => {
      await sleep(300);
      if (heroBottom) heroBottom.style.opacity = '1';
    });

    // Contact terminal — triggered on scroll
    const contactWrapper = document.getElementById('contact-terminal-wrapper');
    if (contactWrapper) {
      const contactObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (!entry.isIntersecting) return;
            contactObserver.unobserve(entry.target);
            runTerminalSequence('contact-terminal', 'contact-cursor');
          });
        },
        { threshold: 0.3 }
      );
      contactObserver.observe(contactWrapper);
    }
  }
</script>
